@{
    ViewBag.Title = "Scoreboard";
}
<script>
    var base_url = '/Scoreboard';
    if (window.location.hostname == 'localhost')
        base_url = '';

    angular.module('scoreboardApp', []).controller('ScoreboardCtrl', function ($scope, $http) {
        $scope.showPlayerRankings = false;
        $scope.refresh = 0;
        $scope.personPredicate = 'score';
        $scope.personReverse = false;
        $scope.pickPredicate = 'sortKey';
        $scope.pickReverse = false;
        $scope.playerPredicate = 'scoreKey';
        $scope.playerReverse = false;

        $scope.scores = {};
        $scope.jeremyL = {
            'name': 'Jeremy Lizza',
            'score': 0,
            'expanded': true, 
            'picks': [
                { 'id': '28237', 'tier': 'A' },
                { 'id': '28089', 'tier': 'B' },
                { 'id': '34046', 'tier': 'B' },
                { 'id': '25632', 'tier': 'C' },
                { 'id': '20848', 'tier': 'C' },
                { 'id': '6527', 'tier': 'C' },
                { 'id': '24357', 'tier': 'D' },
                { 'id': '22792', 'tier': 'D' },
                { 'id': '25198', 'tier': 'D' },
                { 'id': '27214', 'tier': 'D' }
            ]
        };

        $scope.basilU = {
            'name': 'Basil Udoudoh',
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '24502', 'tier': 'A' },
                { 'id': '28089', 'tier': 'B' },
                { 'id': '23108', 'tier': 'B' },
                { 'id': '24781', 'tier': 'C' },
                { 'id': '23983', 'tier': 'C' },
                { 'id': '20848', 'tier': 'C' },
                { 'id': '24357', 'tier': 'D' },
                { 'id': '29420', 'tier': 'D' },
                { 'id': '23135', 'tier': 'D' },
                { 'id': '22378', 'tier': 'D' }
            ]
        };

        $scope.bradR = {
            'name': 'Brad Roller',
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '24502', 'tier': 'A' },
                { 'id': '23108', 'tier': 'B' },
                { 'id': '25686', 'tier': 'B' },
                { 'id': '24781', 'tier': 'C' },
                { 'id': '20396', 'tier': 'C' },
                { 'id': '23983', 'tier': 'C' },
                { 'id': '29420', 'tier': 'D' },
                { 'id': '34098', 'tier': 'D' },
                { 'id': '23135', 'tier': 'D' },
                { 'id': '6567', 'tier': 'D' }
            ]
        };

        $scope.scottH = {
            'name': 'Scott Hankinson',
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '24502', 'tier': 'A' },
                { 'id': '1810', 'tier': 'B' },
                { 'id': '21528', 'tier': 'B' },
                { 'id': '21209', 'tier': 'C' },
                { 'id': '33141', 'tier': 'C' },
                { 'id': '10809', 'tier': 'C' },
                { 'id': '34098', 'tier': 'D' },
                { 'id': '10944', 'tier': 'D' },
                { 'id': '19958', 'tier': 'D' },
                { 'id': '25191', 'tier': 'D' }
            ]
        };

        $scope.douglasB = {
            'name': 'Douglas Borenstein',
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '28237', 'tier': 'A' },
                { 'id': '34046', 'tier': 'B' },
                { 'id': '27649', 'tier': 'B' },
                { 'id': '24781', 'tier': 'C' },
                { 'id': '33141', 'tier': 'C' },
                { 'id': '23983', 'tier': 'C' },
                { 'id': '29420', 'tier': 'D' },
                { 'id': '10944', 'tier': 'D' },
                { 'id': '6567', 'tier': 'D' },
                { 'id': '22378', 'tier': 'D' }
            ]
        };

        $scope.brianO = {
            'name': "Brian O'Connor",
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '28237', 'tier': 'A' },
                { 'id': '1810', 'tier': 'B' },
                { 'id': '28089', 'tier': 'B' },
                { 'id': '24781', 'tier': 'C' },
                { 'id': '21209', 'tier': 'C' },
                { 'id': '23983', 'tier': 'C' },
                { 'id': '29420', 'tier': 'D' },
                { 'id': '6567', 'tier': 'D' },
                { 'id': '25191', 'tier': 'D' },
                { 'id': '20229', 'tier': 'D' }
            ]
        };

        $scope.carlN = {
            'name': 'Carl Newton',
            'score': 0,
            'expanded': true,
            'picks': [
                { 'id': '28237', 'tier': 'A' },
                { 'id': '28089', 'tier': 'B' },
                { 'id': '24024', 'tier': 'B' },
                { 'id': '21209', 'tier': 'C' },
                { 'id': '34099', 'tier': 'C' },
                { 'id': '32839', 'tier': 'C' },
                { 'id': '10944', 'tier': 'D' },
                { 'id': '22792', 'tier': 'D' },
                { 'id': '19958', 'tier': 'D' },
                { 'id': '25191', 'tier': 'D' }
            ]
        };

        $scope.shenanigans = [$scope.jeremyL, $scope.basilU, $scope.bradR, $scope.scottH, $scope.douglasB, $scope.brianO, $scope.carlN];

        $scope.scoresCallback = function (scores) {
            $scope.scores = scores.homeScores;

            // Add data to each player for who has picked them
            for (var i = 0; i < $scope.scores.player.length; i++) {
                $scope.scores.player[i].pickedBy = "";
                $scope.scores.player[i].scoreKey = $scope.getScoreNumber($scope.scores.player[i].score);
                $scope.scores.player[i].todayKey = $scope.getScoreNumber($scope.scores.player[i].today);
            }

            for (var i = 0; i < $scope.shenanigans.length; i++) {
                var currentPerson = $scope.shenanigans[i];
                currentPerson.score = 0;
                currentPerson.base = 0;
                for (var j = 0; j < currentPerson.picks.length; j++) {
                    var currentPlayer = currentPerson.picks[j];
                    var info = $scope.matchPlayerInfo(currentPlayer.id, currentPerson.name);
                    currentPlayer.name = info.fName + ' ' + info.lName;
                    currentPlayer.score = info.score;
                    currentPlayer.today = info.today;
                    currentPlayer.thru = info.thru;
                    currentPlayer.sortKey = $scope.getScoreNumber(info.score);
                    var todayString = 'E';
                    if (currentPlayer.today == 'E' || currentPlayer.today.substring(0, 1) == '+' || currentPlayer.today.substring(0, 1) == '-') {
                        todayString = currentPlayer.today;
                    }
                    currentPlayer.todayKey = $scope.getScoreNumber(todayString);
                    currentPerson.score += $scope.getScoreNumber(info.score);
                    currentPerson.base += (currentPlayer.sortKey - currentPlayer.todayKey);
                }
            }
        };

        $scope.getDelta = function(person){
            var delta = person.score - person.base;
            var value = "";
            if (delta > 0)
                value = "+" + delta;
            else if (delta == 0)
                value = "E";
            else
                value = delta;

            return value;
        };

        $scope.getScoreNumber = function (scoreString) {
            if (scoreString == 'E')
                return 0;
            else
                return parseInt(scoreString);
        };

        $scope.matchPlayerInfo = function (id, pickedBy) {
            for (var i = 0; i < $scope.scores.player.length; i++) {
                if (id == $scope.scores.player[i].id) {
                    if ($scope.scores.player[i].pickedBy.indexOf(pickedBy) == -1) {
                        if ($scope.scores.player[i].pickedBy.length > 0)
                            $scope.scores.player[i].pickedBy += ", ";
                        $scope.scores.player[i].pickedBy += pickedBy;
                    }
                    return $scope.scores.player[i];
                }
            }

            return { name: '', score: '', thru: '', today: '' };
        };

        $scope.loadData = function(){
            $http.get(base_url + '/api/scoreboard').success($scope.scoresCallback);
        };

        $scope.refreshingIn = function () {
            if ($scope.refresh == 0)
                $scope.refresh = 30;
            else
                $scope.refresh = $scope.refresh - 1;

            $scope.$apply($scope.refresh);
        };

        $scope.setPlayerSort = function (sort) {
            if (sort == $scope.playerPredicate)
                $scope.playerReverse = !$scope.playerReverse;
            else {
                $scope.playerReverse = false;
                $scope.playerPredicate = sort;
            }
        };

        $scope.loadData();

        setInterval($scope.refreshingIn, 1000);
        setInterval($scope.loadData, 30000);
    });


</script>

<div ng-app="scoreboardApp" ng-controller="ScoreboardCtrl">
    <h3><span ng-click="showPlayerRankings = false;">Our Rankings</span> | <span ng-click="showPlayerRankings = true;">Player Rankings</span></h3>
    <h4>Refreshing in {{refresh}}</h4>
    <table ng-show="showPlayerRankings">
        <tr>
            <td ng-click="setPlayerSort('lName')"><strong>Player</strong></td>
            <td ng-click="setPlayerSort('scoreKey')"><strong>Score</strong></td>
            <td ng-click="setPlayerSort('todayKey')"><strong>Today</strong></td>
            <td ng-click="setPlayerSort('thru')"><strong>Thru</strong></td>
            <td ng-click="setPlayerSort('pickedBy')"><strong>Picked By</strong></td>
        </tr>
        <tr ng-repeat="player in scores.player | orderBy:playerPredicate:playerReverse">
            <td class="col-md-2">{{player.fName}} {{player.lName}}</td>
            <td class="col-md-1">{{player.score}}</td>
            <td class="col-md-1">{{player.today}}</td>
            <td class="col-md-1">{{player.thru}}</td>
            <td class="col-md-4">{{player.pickedBy}}</td>
        </tr>
    </table>
    <br/>
    <ul ng-hide="showPlayerRankings">
        <li ng-repeat="person in shenanigans | orderBy:personPredicate:personReverse" style="list-style:none">
            <strong ng-click="person.expanded = !person.expanded"><span class="col-md-2">{{person.name}}</span><span class="col-md-2">{{person.score}}</span>({{getDelta(person)}} today)</strong>
            <table ng-show="person.expanded">
                <tr><td class="col-md-1"></td><td class="col-md-5">Player</td><td class="col-md-2">Score</td><td class="col-md-2">Today</td><td class="col-md-2">Thru</td></tr>
                <tr ng-repeat="pick in person.picks | orderBy:pickPredicate:pickReverse">
                    <td class="col-md-1"></td>
                    <td class="col-md-5">{{pick.name}}  ({{pick.tier}})</td>
                    <td class="col-md-2">{{pick.score}}</td>
                    <td class="col-md-2">{{pick.today}}</td>
                    <td class="col-md-2">{{pick.thru}}</td>
                </tr>
            </table>
        </li>
    </ul>
</div>